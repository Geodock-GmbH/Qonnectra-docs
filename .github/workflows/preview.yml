name: Build PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.md'
      - '.vitepress/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/preview.yml'

permissions:
  contents: read
  pull-requests: write

# Allow concurrent PR preview builds
concurrency:
  group: preview-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  build-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: package.json

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: true
      
      - name: Build with VitePress
        run: pnpm run build
        env:
          # Set base path for PR preview: /Qonnectra-docs/pr-{PR_NUMBER}/
          BASE_PATH: /Qonnectra-docs/pr-${{ github.event.pull_request.number }}/
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: preview-build-pr-${{ github.event.pull_request.number }}
          path: .vitepress/dist
          retention-days: 7
      
      - name: Comment PR with instructions
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const branchName = context.payload.pull_request.head.ref;
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ **Preview build completed!**\n\nüì¶ Build artifact is available for download from the Actions tab (artifact name: \`preview-build-pr-${prNumber}\`).\n\nüåê **To enable GitHub Pages preview for this branch:**\n\n1. Download the build artifact from the Actions tab\n2. Extract the \`.vitepress/dist\` folder contents\n3. Commit and push the \`dist\` folder to your branch (or create a \`gh-pages\` branch with the dist contents)\n4. Go to Repository Settings ‚Üí Pages\n5. Under "Source", select "Deploy from a branch"\n6. Select your branch or the \`gh-pages\` branch\n7. Select folder: \`/dist\` (or root if you put dist at root)\n8. Click Save\n\n‚ö†Ô∏è **Important Notes:**\n- The build uses base path \`/Qonnectra-docs/pr-${prNumber}/\`\n- GitHub Pages can only serve from one branch at a time\n- Enabling Pages for a PR branch will temporarily replace the main site\n- Remember to switch back to \`main\` branch after reviewing\n\nOnce enabled, your preview will be available at:\n\`https://geodock-gmbh.github.io/Qonnectra-docs/pr-${prNumber}/\``
            });

